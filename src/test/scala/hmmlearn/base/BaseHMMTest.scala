package hmmlearn.base

import breeze.linalg.{DenseMatrix, DenseVector}
import breeze.numerics.log
import org.scalatest.{FlatSpec, Matchers}


class BaseHMMTest extends FlatSpec with Matchers {

  "doForwardPass" should "produce the right results" in {
    val startProb = DenseVector(0.15, 0.40, 0.25, 0.20)
    val transMat = DenseMatrix(
      (0.80, 0.10, 0.05, 0.05),
      (0.01, 0.90, 0.08, 0.01),
      (0.00, 0.05, 0.80, 0.15),
      (0.10, 0.00, 0.10, 0.80)
    )
    val frameLogProb = DenseMatrix(
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895)
    )
    val (logProb, fwdLattice) = (BaseHMM.doForwardPass(frameLogProb, startProb, transMat))
    logProb shouldBe -14.796277458117423
    fwdLattice shouldBe DenseMatrix(
      (-3.4011199848858813, -2.248290731874155, -3.4842943611198907, -3.5044379124341),
      (-4.986486853374993, -3.6356962911817767, -5.377160942259737, -5.356749169283107),
      (-6.587372186080435, -5.035261558707974, -7.115798048957688, -7.179168908044341),
      (-8.193906178881925, -6.4426068419965326, -8.73175858796781, -8.947094027588804),
      (-9.79805014800824, -7.855358813836463, -10.266965821733141, -10.647677187966591),
      (-11.393581745199297, -9.272028942484281, -11.754982908003036, -12.28060097363618),
      (-12.975944441188334, -10.69159390950848, -13.216928334133701, -13.855182482440323),
      (-14.542135877607551, -12.113315579170772, -14.664661376666757, -15.384857368237576),
      (-16.090601354308287, -13.5366494762583, -16.104555443864065, -16.88250593137685),
      (-17.621072356314837, -14.96119010820828, -17.54001352882171, -18.35828290698776)
    )
  }

  "doBackwardPass" should "produce the right results" in {
    val startProb = DenseVector(0.15, 0.40, 0.25, 0.20)
    val transMat = DenseMatrix(
      (0.80, 0.10, 0.05, 0.05),
      (0.01, 0.90, 0.08, 0.01),
      (0.00, 0.05, 0.80, 0.15),
      (0.10, 0.00, 0.10, 0.80)
    )
    val frameLogProb = DenseMatrix(
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895),
      (-1.504, -1.332, -2.098, -1.895)
    )
    val bwdLattice = (BaseHMM.doBackwardPass(frameLogProb, startProb, transMat))
    bwdLattice shouldBe DenseMatrix(
      (-13.455970284141562, -12.747792321158617, -14.915747260381446, -14.920995105499776),
      (-11.99943739676506, -11.320744201212742, -13.462820460873429, -13.429165330709386),
      (-10.53499920436706, -9.894147309504007, -11.995406392659312, -11.914361356750371),
      (-9.06107909829773, -8.468234583820815, -10.50393183643525, -10.368467521528451),
      (-7.576198120931601, -7.043398173697517, -8.973180466383678, -8.781649116681189),
      (-6.0792896901600315, -5.6203286918455575, -7.381321590324025, -7.1435461096034825),
      (-4.570188869372142, -4.200301644845261, -5.702416295327662, -5.445774888565715),
      (-3.050359632761887, -2.7857964471064958, -3.9146522074850623, -3.685145572861401),
      (-1.5240062864678254, -1.3819213116205802, -2.0106137752124766, -1.865952323036577),
      (0.0, 0.0, 0.0, 0.0)
    )
  }

}
